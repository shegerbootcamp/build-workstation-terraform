#cloud-config
users:
  - default
  - name: ${USERNAME}
    gecos: ${USERNAME}
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: wheel
    lock_passwd: false
    ssh-authorized-keys:
      - ${PUBLIC_KEY_CONTENT}
write_files:
  - path: /run/scripts/test-script.sh
    content: |
      #!/bin/bash

      yum install python3.11 -y

      python3.11 -m pip install watchmaker

      PYPI_URL=https://pypi.org/simple

      # Setup terminal support for UTF-8
      export LC_ALL=en_US.UTF-8
      export LANG=en_US.UTF-8

      # Install pip
      python3 -m ensurepip

      # Install setup dependencies
      python3 -m pip install --index-url="$PYPI_URL" --upgrade pip setuptools

      # Install Watchmaker
      python3 -m pip install --index-url="$PYPI_URL" --upgrade watchmaker

      # Run Watchmaker
      watchmaker --log-level debug --log-dir=/var/log/watchmaker

      echo "User-data script completed."

      echo 'Watch maker Script executed successfully!' >> /run/testing.txt      
    permissions: '0755'

runcmd:
  - [ sh, "/run/scripts/test-script.sh" ]